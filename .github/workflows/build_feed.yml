name: Build filtered CSV feed + Amazon feeds (multi-country)

on:
  schedule:
    - cron: "*/15 * * * *"
    - cron: "5 0 * * *"
  workflow_dispatch:

concurrency:
  group: feed-filter
  cancel-in-progress: true

jobs:
  ###########################################################################
  # COMMON JOB — genera filtered.csv e lo carica come artifact
  ###########################################################################
  build_common:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Python deps (Google + SP-API)
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2
          pip install requests botocore

      - name: Download source CSV
        run: |
          curl -L --retry 5 --retry-delay 5 --connect-timeout 30 --max-time 3600 \
            "${{ secrets.SOURCE_CSV_URL }}" -o source.csv

      - name: Filter CSV
        run: |
          python filter_feed.py
          ls -lh filtered.csv
          head -n 2 filtered.csv | cat

      - name: Upload filtered.csv artifact
        uses: actions/upload-artifact@v4
        with:
          name: filtered-csv
          path: filtered.csv
          retention-days: 1

      - name: Write service account JSON to file
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
        run: |
          echo "$GDRIVE_SA_JSON" > sa.json

      - name: Upload filtered.csv to Google Sheet "Filtered"
        env:
          FILTERED_SHEET_ID: ${{ secrets.FILTERED_SHEET_ID }}
          INPUT_CSV: filtered.csv
          FILTERED_SHEET_NAME: Filtered
        run: |
          python upload_csv_to_sheet.py

  ###########################################################################
  # MATRIX JOB — IT, FR, DE, ES
  ###########################################################################
  amazon_feeds:
    needs: build_common
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        country: [it, fr, de, es]
        include:
          - country: it
            marketplace: APJ6JRA9NG5V4
            locale: it_IT
          - country: fr
            marketplace: A13V1IB3VIYZZH
            locale: fr_FR
          - country: de
            marketplace: A1PA6795UKMFR9
            locale: de_DE
          - country: es
            marketplace: A1RKKUPIHCS9HS
            locale: es_ES

    steps:
      - uses: actions/checkout@v4

      - name: Download filtered.csv artifact
        uses: actions/download-artifact@v4
        with:
          name: filtered-csv
          path: .

      - name: Install Python deps (Google + SP-API)
        run: |
          python -m pip install --upgrade pip
          pip install google-api-python-client google-auth google-auth-httplib2
          pip install requests botocore

      - name: Write service account JSON to file
        env:
          GDRIVE_SA_JSON: ${{ secrets.GDRIVE_SA_JSON }}
        run: |
          echo "$GDRIVE_SA_JSON" > sa.json

      #######################################################################
      # GENERAZIONE FEED AMAZON (JSON_LISTINGS_FEED)
      #######################################################################
      - name: Generate Amazon feeds
        env:
          GSHEET_ID: ${{ secrets.GSHEET_ID }}
          COUNTRY: ${{ matrix.country }}
          AMAZON_SELLER_ID: ${{ secrets.AMAZON_SELLER_ID }}
        run: |
          python generate_amazon_feeds.py
          ls -lh amazon_${{ matrix.country }}_*

      #######################################################################
      # CACHE HASH DOPO GENERAZIONE
      #######################################################################
      - name: Restore listings hash cache
        uses: actions/cache@v4
        with:
          path: .cache
          key: listings-hash-${{ matrix.country }}-${{ github.ref_name }}
          restore-keys: listings-hash-${{ matrix.country }}-

      #######################################################################
      # CHECK SE IL JSON È CAMBIATO
      #######################################################################
      - name: Check if listings JSON changed
        id: check_json
        run: |
          mkdir -p .cache
          FILE=amazon_${{ matrix.country }}_listings.json
          test -f "$FILE"
          NEW_HASH=$(md5sum "$FILE" | awk '{print $1}')
          OLD_HASH=$(cat .cache/${FILE}.md5 2>/dev/null || true)
          if [ "$NEW_HASH" = "$OLD_HASH" ] && [ -n "$NEW_HASH" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "$NEW_HASH" > .cache/${FILE}.md5
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      #######################################################################
      # INVIO JSON_LISTINGS_FEED
      #######################################################################
      - name: Send JSON_LISTINGS_FEED
        if: steps.check_json.outputs.changed == 'true'
        env:
          SPAPI_LWA_CLIENT_ID: ${{ secrets.SPAPI_LWA_CLIENT_ID }}
          SPAPI_LWA_CLIENT_SECRET: ${{ secrets.SPAPI_LWA_CLIENT_SECRET }}
          SPAPI_LWA_REFRESH_TOKEN: ${{ secrets.SPAPI_LWA_REFRESH_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          FILE=amazon_${{ matrix.country }}_listings.json
          FEED_OUTPUT=$(python publish_spapi_feed.py \
            --file "$FILE" \
            --feed-type JSON_LISTINGS_FEED \
            --marketplace ${{ matrix.marketplace }})
          echo "$FEED_OUTPUT"
          FEED_ID=$(echo "$FEED_OUTPUT" | grep -o '"feedId": *"[0-9]*"' | grep -o '[0-9]*')
          echo "FEED_ID=$FEED_ID" >> $GITHUB_ENV

      - name: Check feed status
        if: steps.check_json.outputs.changed == 'true'
        env:
          SPAPI_LWA_CLIENT_ID: ${{ secrets.SPAPI_LWA_CLIENT_ID }}
          SPAPI_LWA_CLIENT_SECRET: ${{ secrets.SPAPI_LWA_CLIENT_SECRET }}
          SPAPI_LWA_REFRESH_TOKEN: ${{ secrets.SPAPI_LWA_REFRESH_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          sleep 20
          python check_spapi_feed.py --feed-id $FEED_ID
          head -n 120 feed_processing_report.txt || true

      #######################################################################
      # ARTIFACTS
      #######################################################################
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.country }}-files
          path: |
            amazon_${{ matrix.country }}_listings.json
            amazon_${{ matrix.country }}_b2c.csv
            amazon_${{ matrix.country }}_b2b.csv
            amazon_${{ matrix.country }}_price_quantity.txt
            feed_status.json
            feed_processing_report.txt
            feed_document_meta.json
          retention-days: 7

      #######################################################################
      # BACKUP SU DRIVE — UNO STEP PER PAESE
      #######################################################################
      - name: Upload listings.json to Drive (IT)
        if: always() && matrix.country == 'it'
        env:
          FILE_ID: ${{ secrets.AMAZON_IT_LISTINGS_JSON_FILE_ID }}
          LOCAL_FILE: amazon_it_listings.json
        run: |
          test -f "$LOCAL_FILE"
          python upload_to_drive.py

      - name: Upload listings.json to Drive (FR)
        if: always() && matrix.country == 'fr'
        env:
          FILE_ID: ${{ secrets.AMAZON_FR_LISTINGS_JSON_FILE_ID }}
          LOCAL_FILE: amazon_fr_listings.json
        run: |
          test -f "$LOCAL_FILE"
          python upload_to_drive.py

      - name: Upload listings.json to Drive (DE)
        if: always() && matrix.country == 'de'
        env:
          FILE_ID: ${{ secrets.AMAZON_DE_LISTINGS_JSON_FILE_ID }}
          LOCAL_FILE: amazon_de_listings.json
        run: |
          test -f "$LOCAL_FILE"
          python upload_to_drive.py

      - name: Upload listings.json to Drive (ES)
        if: always() && matrix.country == 'es'
        env:
          FILE_ID: ${{ secrets.AMAZON_ES_LISTINGS_JSON_FILE_ID }}
          LOCAL_FILE: amazon_es_listings.json
        run: |
          test -f "$LOCAL_FILE"
          python upload_to_drive.py
